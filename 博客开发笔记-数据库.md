# 全栈个人博客开发笔记-数据库

#### 背景



> 今年是我的本命年，正式从事前端开发已18个月，日复一日做着重复简单的工作，渐渐成为了”酸菜鱼“、”黄焖鸡“，我要改变自己，走出舒适圈。。从这个伪全栈的博客（vue-element-admin + egg.js + nuxtjs）开发开始。。。成为一个合格的程序员！



#### 前言

>  我对于数据库方面接触甚少，所学知识仅限于带专时期有关数据库书的目录，所以一切从0开始查，此篇主要记录实践过程

#### 数据库表设计

开发博客后台管理功能，首要先搞清博客系统表的设计，弄清需求，这样方便后期开发接口，不至于混乱。作为小白，设计实在无从下手，就去查资料博客，查到了下面这个博文，理解后点个赞就copy🤣了下来使用（也不知犯不犯法）附链接：

#### 参考资料

- [个人博客数据库设计](https://juejin.im/post/5c96421e6fb9a070f12583bf)

  <img src="https://cdn.jsdelivr.net/gh/Thawsoar/FigureBed@master//img/169aaf241892dc5a.png" style="zoom: 33%;" />

***

####  实践过程

> 前端开发者开发后台功能，nodejs是最易上手的，当然实际项目中要选择稳定的框架库减少工作量，egg.js是基于koa2制定一系列规范的框架，文档详尽，所以后台服务我使用了egg.js，数据库用的是mysql8

##### 使用 egg-sequelize 和 mysql2来建立表model方便管理，

egg-sequelize 它会辅助我们将定义好的 Model 对象加载到 app 和 ctx 上）和 mysql2 模块。 [官网教程](https://eggjs.org/zh-cn/tutorials/sequelize.html),操作如下：

1. 安装包并配置

```js
 yarn add egg-sequelize mysql2
```

2. 在 config/plugin.js 中引入 egg-sequelize 插件

```js
exports.sequelize = {
  enable: true,
  package: 'egg-sequelize',
};
```



3. 在 config/config.default.js 中编写 sequelize 配置

```js
sequelize = {

  dialect: 'mysql',

  host: '127.0.0.1',

  port: 3306,

  database: 'egg-server',

  username: 'root',

  password: 'password',

};
```

#####  初始化数据库

- 可以直接使用mysql命令建库表 或者 客户端（Navicat Premium）建库表，缺点是不利于多人协作，跟踪数据迭代

- 使用Migrations 来帮我们管理数据结构的变更，操作如下：

1. 安装包

```js
yarn add sequelize-cli
```

2. 根目录下新建一个 .sequelizerc 配置文件：

```js
'use strict';

const path = require('path');

module.exports = {

  config: path.join(__dirname, 'database/config.json'),

  'migrations-path': path.join(__dirname, 'database/migrations'),

  'seeders-path': path.join(__dirname, 'database/seeders'),

  'models-path': path.join(__dirname, 'app/model'),

};
```



3. 初始化 Migrations 配置文件和目录

```js
npx sequelize init:config
npx sequelize init:migrations
```



4. 生成database文件夹后 修改database/config.json

```js
{

	"development": {

    "username": "root",

    "password": "password",

    "database": "egg-server",

    "host": "127.0.0.1",

  	"dialect": "mysql"

  },

  "test": {

    "username": "root",

    "password": null,

    "database": "database_test",

    "host": "127.0.0.1",

    "dialect": "mysql",

    "operatorsAliases": false

  },

  "production": {

    "username": "root",

    "password": null,

    "database": "database_production",

    "host": "127.0.0.1",

    "dialect": "mysql",

    "operatorsAliases": false

  }

}
```



5. 生成migration文件*${timestamp}-init-users.js*，初始化user表

```js
npx sequelize migration:generate --name=init-user
```



6. 修改migration user文件

```js
'use strict';

module.exports = {

// 在执行数据库升级时调用的函数，创建 user 表

up: async (queryInterface, Sequelize) => {

  const { INTEGER, DATE, STRING, UUID } = Sequelize;

  await queryInterface.createTable('user', {

    id: {
      type: UUID,
      primaryKey: true,
      allowNull: false,
      comment: '用户ID',
    },

    ip: {
      type: STRING(20),
      comment: '用户IP',
    },

    username: {
      type: STRING(20),
      comment: '用户姓名',
    },

    password: {
      type: STRING(16),
      comment: '用户密码',
    },
    email: {
      type: STRING(30),
      unique: true,
      comment: '用户邮箱',
    },

    profile_pho: {
      type: STRING(255),
      comment: '用户头像',
    },
    registration: {
      type: DATE,
      comment: '用户注册时间',
    },
    birthday: {
      type: DATE,
      comment: '用户生日',
    },
    age: {
      type: INTEGER(4),
      comment: '用户年龄',
    },

    telephone: {
      type: INTEGER(11),
      comment: '用户手机',
    },

    nickname: {
      type: STRING(20),
      comment: '用户昵称',
    },

    created_at: {
      type: DATE,
      comment: '创建时间',
    },

    updated_at: {
      type: DATE,
      comment: '修改时间',
    },
    version: true,
  });
},

	// 在执行数据库降级时调用的函数，删除 user 表
down: async queryInterface => {
		await queryInterface.dropTable('user');
	},
};
```

7. 执行 migrate 进行数据库变更

```
# 升级数据库

npx sequelize db:migrate
# 如果有问题需要回滚，可以通过 `db:migrate:undo` 回退一个变更
# do
# 可以通过 `db:migrate:undo:all` 回退到初始状态
# npx sequelize db:migrate:undo:all
```



至此，user表就建立了， 博客系统的其他表也使用migrations依次建立即可。